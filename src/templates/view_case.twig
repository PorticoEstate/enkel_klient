{# filepath: /home/hc483/enkel_klient/src/templates/view_case.twig #}
{% extends 'head.twig' %}

{% block body %}
	<div class="container mt-4">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1>Sak #{{ case.id }}</h1>
			<a href="{{ base_path }}/my_cases" class="btn btn-outline-secondary">
				<i class="fas fa-arrow-left me-2"></i>Tilbake til saksoversikt
			</a>
		</div>

		{% if success is not empty %}
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				{% if success == 'response_added' %}
					<i class="fas fa-check-circle me-2"></i>Kommentaren din ble lagt til.
				{% else %}
					<i class="fas fa-check-circle me-2"></i>Handlingen ble fullført.
				{% endif %}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Lukk"></button>
			</div>
		{% endif %}

		{% if error is not empty %}
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				{% if 'file_too_large_server' in error %}
					<i class="fas fa-exclamation-circle me-2"></i>Filen er for stor for serveren. 
																						            Maksimal filstørrelse er
					{{ php_upload_max_filesize|default('25') }}
					MB. 
																		            Vennligst komprimer filen eller del den opp i mindre filer.
				{% elseif 'empty_content' in error %}
					<i class="fas fa-exclamation-circle me-2"></i>Kommentarfeltet kan ikke være tomt.
				{% elseif 'file_too_large' in error and 'invalid_file_type' in error %}
					<i class="fas fa-exclamation-circle me-2"></i>Filen er for stor (maks 10MB) og har et ugyldig format. Støttede formater: PDF, Word, Excel, JPG og PNG.
				{% elseif 'file_too_large' in error %}
					<i class="fas fa-exclamation-circle me-2"></i>Filen er for stor. Maksimal filstørrelse er 10MB.
				{% elseif 'invalid_file_type' in error %}
					<i class="fas fa-exclamation-circle me-2"></i>Ugyldig filformat. Støttede formater: PDF, Word, Excel, JPG og PNG.
				{% elseif 'api_error' in error %}
					<i class="fas fa-exclamation-circle me-2"></i>Det oppstod en feil ved sending av kommentar. Vennligst prøv igjen senere.
				{% else %}
					<i class="fas fa-exclamation-circle me-2"></i>
					{{ error }}
				{% endif %}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Lukk"></button>
			</div>
		{% endif %}


		<div class="card mb-4">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">{{ case.subject }}</h5>
				<span class="badge {{ case.status_class|default('bg-secondary') }}">{{ case.status_text|default('Ukjent status') }}</span>
			</div>
			<div class="card-body">
				<div class="row mb-3">
					<div class="col-md-6">
						<p class="mb-1">
							<strong>Registrert dato:</strong>
							{% if case.registered_date is defined and case.registered_date %}
								{{ case.registered_date|date('d.m.Y H:i') }}
							{% else %}
								-
							{% endif %}
						</p>
						<p class="mb-1">
							<strong>Saksnummer:</strong>
							#{{ case.id }}</p>
						{% if case.location_code is defined and case.location_code %}
							<p class="mb-1">
								<strong>Adresse:</strong>
								{{ case.address|default('-') }}</p>
						{% endif %}
					</div>
					<div class="col-md-6">
						<p class="mb-1">
							<strong>Sist oppdatert:</strong>
							{% if case.status_change_date is defined and case.status_change_date %}
								{{ case.status_change_date|date('d.m.Y H:i') }}
							{% else %}
								-
							{% endif %}
						</p>
						<p class="mb-1">
							<strong>Kategori:</strong>
							{{ case.category|default('-') }}</p>
						{% if case.phone is defined and case.phone %}
							<p class="mb-1">
								<strong>Telefon:</strong>
								{{ case.phone }}</p>
						{% endif %}
						{% if case.email is defined and case.email %}
							<p class="mb-1">
								<strong>E-post:</strong>
								{{ case.email }}</p>
						{% endif %}
					</div>
				</div>

				<div class="mt-4">
					<h6 class="mb-3">Beskrivelse</h6>
					<div class="p-3 bg-light rounded">
						{{ case.details|raw }}
					</div>
				</div>
			</div>
		</div>

		{% if attachments|length > 0 %}
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">Vedlegg</h5>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>Filnavn</th>
									<th>Type</th>
									<th>Størrelse</th>
									<th>Dato</th>
									<th>Handling</th>
								</tr>
							</thead>
							<tbody>
								{% for attachment in attachments %}
									<tr>
										<td>{{ attachment.name }}</td>
										<td>{{ attachment.type }}</td>
										<td>{{ attachment.file_size|default(0)|number_format(0, ',', ' ') }}
											KB</td>
										<td>
											{% if attachment.created_on is defined %}
												{{ attachment.created_on|date('d.m.Y') }}
											{% else %}
												-
											{% endif %}
										</td>
										<td>
											<a href="{{ base_path }}/my_cases/download/{{ case.id }}/{{ attachment.id }}" class="btn btn-sm btn-outline-primary">
												<i class="fas fa-download me-1"></i>Last ned
											</a>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		{% endif %}

		{% if history|length > 0 %}
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">Sakshistorikk</h5>
				</div>
				<div class="card-body">
					<div class="timeline">
						{% for item in history %}
							<div class="timeline-item mb-4">
								<div class="d-flex">
									<div class="timeline-marker me-3">
										<i class="fas fa-circle text-primary"></i>
									</div>
									<div class="timeline-content">
										<div class="d-flex justify-content-between">
											<h6 class="mb-1">{{ item.value_user|default('System') }}</h6>

											<small class="text-muted">
												{% if item.value_date is defined %}

													{{ item.value_date }}

												{% endif %}
											</small>
										</div>
										{% if item.value_new_value is defined %}

											<div class="p-3 bg-light rounded">
												{{ item.value_action }}:&nbsp;
												{{ item.value_new_value }}

											</div>

										{% else %}

											<div class="p-3 bg-light rounded">
												{{ item.value_note|raw|default('') }}

											</div>
										{% endif %}
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>
		{% endif %}
		<div class="card mb-4">
			<div class="card-header">
				<h5 class="mb-0">Legg til kommentar</h5>
			</div>
			<div class="card-body">
				<form method="post" action="{{ base_path }}/my_cases/respond/{{ case.id }}" enctype="multipart/form-data">
					<div class="mb-3">
						<label for="responseContent" class="form-label">Din kommentar</label>
						<textarea class="form-control" id="responseContent" name="content" rows="4" required>{{ preserved_content }}</textarea>

						<div class="form-text">Din kommentar vil bli synlig for alle som har tilgang til denne saken.</div>
					</div>

					<div class="mb-3">
						<label for="responseAttachment" class="form-label">Legg ved fil (valgfritt)</label>
						<input class="form-control" type="file" id="responseAttachment" name="attachment">
						<div class="form-text">Støttede filtyper: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (maks 10MB)</div>
					</div>

					{% if csrf_token is defined %}
						<input type="hidden" name="csrf_token" value="{{ csrf_token }}">
					{% endif %}

					<div class="d-flex justify-content-end">
						<button type="submit" class="btn btn-primary">
							<i class="fas fa-paper-plane me-2"></i>Send kommentar
						</button>
					</div>
					{# Add this to view_case.twig just before the closing </form> tag #}

					<script>
						document.addEventListener('DOMContentLoaded', function () {
const fileInput = document.getElementById('responseAttachment');
const submitButton = document.querySelector('button[type="submit"]');
const maxFileSizeBytes = 10 * 1024 * 1024;
// 10MB in bytes

// Create feedback element
const feedbackDiv = document.createElement('div');
feedbackDiv.className = 'invalid-feedback d-none';
fileInput.parentNode.appendChild(feedbackDiv);

fileInput.addEventListener('change', function () { // Reset state
fileInput.classList.remove('is-invalid');
feedbackDiv.classList.add('d-none');
submitButton.disabled = false;

if (this.files && this.files[0]) {
const fileSize = this.files[0].size;

// Check file size against our 10MB limit
if (fileSize > maxFileSizeBytes) {
fileInput.classList.add('is-invalid');
feedbackDiv.textContent = `Filen er for stor. Maksimal filstørrelse er ${
formatFileSize(maxFileSizeBytes)
}. Din fil er ${
formatFileSize(fileSize)
}.`;
feedbackDiv.classList.remove('d-none');
submitButton.disabled = true;

// Reset file input to clear selection
this.value = '';
return;
}

// Show file size information
feedbackDiv.textContent = `Valgt fil: ${
this.files[0].name
} (${
formatFileSize(fileSize)
})`;
feedbackDiv.classList.remove('d-none');
feedbackDiv.classList.remove('invalid-feedback');
feedbackDiv.classList.add('text-muted', 'small');
}
});

// Format file size in KB, MB
function formatFileSize(bytes) {
if (bytes < 1024) {
return bytes + ' bytes';
}
else if (bytes < 1024 * 1024) {
return(bytes / 1024).toFixed(1) + ' KB';
}
else {
return(bytes / (1024 * 1024)).toFixed(1) + ' MB';
}
}

// Add form submission validation
const form = fileInput.closest('form');
form.addEventListener('submit', function (event) {
if (fileInput.files && fileInput.files[0]) {
const fileSize = fileInput.files[0].size;

if (fileSize > maxFileSizeBytes) {
event.preventDefault();
alert('Filen er for stor. Maksimal filstørrelse er 10MB.');
return false;
}
}
});
});
					</script>

				</form>
			</div>
		</div>

		<div class="text-center mt-4 mb-5">
			<a href="{{ base_path }}/my_cases" class="btn btn-primary">
				<i class="fas fa-arrow-left me-2"></i>Tilbake til saksoversikt
			</a>
		</div>
	</div>

	<style>
		.timeline {
			position: relative;
			padding-left: 1rem;
		}

		.timeline::before {
			content: '';
			position: absolute;
			left: 0.5rem;
			top: 0;
			height: 100%;
			width: 2px;
			background: #e9ecef;
		}

		.timeline-marker {
			position: relative;
			top: 5px;
		}

		.timeline-content {
			flex: 1;
		}
	</style>
{% endblock %}

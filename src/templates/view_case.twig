{# filepath: /home/hc483/enkel_klient/src/templates/view_case.twig #}
{% extends 'head.twig' %}

{% block body %}
	<div class="container mt-4">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1>Sak #{{ case.id }}</h1>
			<a href="{{ str_base_url }}/my_cases" class="btn btn-outline-secondary">
				<i class="fas fa-arrow-left me-2"></i>Tilbake til saksoversikt
			</a>
		</div>

		<div class="card mb-4">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">{{ case.subject }}</h5>
				<span class="badge {{ case.status_class|default('bg-secondary') }}">{{ case.status_text|default('Ukjent status') }}</span>
			</div>
			<div class="card-body">
				<div class="row mb-3">
					<div class="col-md-6">
						<p class="mb-1">
							<strong>Registrert dato:</strong>
							{% if case.registered_date is defined and case.registered_date %}
								{{ case.registered_date|date('d.m.Y H:i') }}
							{% else %}
								-
							{% endif %}
						</p>
						<p class="mb-1">
							<strong>Saksnummer:</strong>
							#{{ case.id }}</p>
						{% if case.location_code is defined and case.location_code %}
							<p class="mb-1">
								<strong>Adresse:</strong>
								{{ case.address|default('-') }}</p>
						{% endif %}
					</div>
					<div class="col-md-6">
						<p class="mb-1">
							<strong>Sist oppdatert:</strong>
							{% if case.status_change_date is defined and case.status_change_date %}
								{{ case.status_change_date|date('d.m.Y H:i') }}
							{% else %}
								-
							{% endif %}
						</p>
						<p class="mb-1">
							<strong>Kategori:</strong>
							{{ case.category|default('-') }}</p>
						{% if case.phone is defined and case.phone %}
							<p class="mb-1">
								<strong>Telefon:</strong>
								{{ case.phone }}</p>
						{% endif %}
						{% if case.email is defined and case.email %}
							<p class="mb-1">
								<strong>E-post:</strong>
								{{ case.email }}</p>
						{% endif %}
					</div>
				</div>

				<div class="mt-4">
					<h6 class="mb-3">Beskrivelse</h6>
					<div class="p-3 bg-light rounded">
						{{ case.message|raw }}
					</div>
				</div>
			</div>
		</div>

		{% if attachments|length > 0 %}
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">Vedlegg</h5>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>Filnavn</th>
									<th>Type</th>
									<th>St√∏rrelse</th>
									<th>Dato</th>
									<th>Handling</th>
								</tr>
							</thead>
							<tbody>
								{% for attachment in attachments %}
									<tr>
										<td>{{ attachment.name }}</td>
										<td>{{ attachment.type }}</td>
										<td>{{ attachment.file_size|default(0)|number_format(0, ',', ' ') }}
											KB</td>
										<td>
											{% if attachment.created_on is defined %}
												{{ attachment.created_on|date('d.m.Y') }}
											{% else %}
												-
											{% endif %}
										</td>
										<td>
											<a href="{{ str_base_url }}/my_cases/download/{{ case.id }}/{{ attachment.id }}" class="btn btn-sm btn-outline-primary">
												<i class="fas fa-download me-1"></i>Last ned
											</a>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		{% endif %}

		{% if history|length > 0 %}
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">Sakshistorikk</h5>
				</div>
				<div class="card-body">
					<div class="timeline">
						{% for item in history %}
							<div class="timeline-item mb-4">
								<div class="d-flex">
									<div class="timeline-marker me-3">
										<i class="fas fa-circle text-primary"></i>
									</div>
									<div class="timeline-content">
										<div class="d-flex justify-content-between">
											<h6 class="mb-1">{{ item.user_name|default('System') }}</h6>
											<small class="text-muted">
												{% if item.created_on is defined %}
													{{ item.created_on|date('d.m.Y H:i') }}
												{% endif %}
											</small>
										</div>
										<div class="mb-2">
											{% if item.status_text is defined %}
												<span class="badge bg-info me-2">Status endret til:
													{{ item.status_text }}</span>
											{% endif %}
										</div>
										<div class="p-3 bg-light rounded">
											{{ item.comment|raw|default('') }}
										</div>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>
		{% endif %}

		<div class="text-center mt-4 mb-5">
			<a href="{{ str_base_url }}/my_cases" class="btn btn-primary">
				<i class="fas fa-arrow-left me-2"></i>Tilbake til saksoversikt
			</a>
		</div>
	</div>

	<style>
		.timeline {
			position: relative;
			padding-left: 1rem;
		}

		.timeline::before {
			content: '';
			position: absolute;
			left: 0.5rem;
			top: 0;
			height: 100%;
			width: 2px;
			background: #e9ecef;
		}

		.timeline-marker {
			position: relative;
			top: 5px;
		}

		.timeline-content {
			flex: 1;
		}
	</style>
{% endblock %}
